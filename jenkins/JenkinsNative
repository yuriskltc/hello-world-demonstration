pipeline  {
    agent any
    environment {
        uploadSpec = ''
        server = ''
    }
    stages{
        stage ('Artifactory configuration') {         
            steps{
                script{
                    server = Artifactory.server 'JFROGTST'
                }
            }
        }
        stage('Fetch') {
            steps {
                git credentialsId: 'GITHUB', url: 'https://github.com/yuriskltc/simple-java-maven-app.git'
            }
        }
        
        stage('Test') {        
            steps{
                withMaven(maven:'Maven'){
                    sh 'mvn -Dv=${BUILD_NUMBER} test'        
                }
            }
        }
        stage('Build') {
            steps{
                withMaven(maven:'Maven'){
                    sh 'mvn -B -DskipTests -Dv=${BUILD_NUMBER} clean package -U'
                }
            }
        }
        stage ('Deploy') {   
            environment{
                uploadSpec = '''{
                    "files": [
                        {
                            "pattern": "target/*.jar",
                            "target": "my-libs-release-local"                  
                        }, {
                            "pattern": "target/*.pom",
                            "target": "my-libs-release-local"
                        }]
                }'''    
            }         
            steps{                               
                script{
                    sh 'cp pom.xml target/my-app-1.1.${BUILD_NUMBER}-SNAPSHOT.pom'
                    def buildInfo = Artifactory.newBuildInfo()
                    buildInfo.env.collect()
                    server.upload spec: uploadSpec, buildInfo: buildInfo
                    server.publishBuildInfo buildInfo
                }
            }
        }
        stage ('PostBuild') {
            steps{
                build job: 'CD pipeline', parameters: [string(name: 'BUILDNUM', value: "${BUILD_NUMBER}" )]
            }
        }
    }
}
