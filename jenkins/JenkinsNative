
pipeline  {
    environment {
        uploadSpec = ''
        server = ''
    }
    stage ('Artifactory configuration') {         
        steps{
             server = Artifactory.server 'JFROGTST'
         }
    }
    stage('Fetch') {
        steps {
            git credentialsId: 'GITHUB', url: 'https://github.com/yuriskltc/simple-java-maven-app.git'
         }
    }
    withMaven(maven:'Maven') {
      stage('Test') {        
            steps{
                sh 'mvn -Dv=${BUILD_NUMBER} test'        
            }
      }
      stage('Build') {
        steps{
            sh 'mvn -B -DskipTests -Dv=${BUILD_NUMBER} clean package'
        }
      }
    }
    stage ('Deploy') {      
        steps{
            sh 'cp pom.xml target/my-app.1.1.{BUILD_NUMBER}.pom'
            def buildInfo = Artifactory.newBuildInfo()
            uploadSpec =
                 '''{
                    "files": [
                        {
                            "pattern": "target/*.jar",
                            "target": "my-libs-release-local"                  
                        }, {
                            "pattern": "target/*.pom",
                            "target": "my-libs-release-local"
                        }]
                }'''    
            buildInfo.env.collect()
            server.upload spec: uploadSpec, buildInfo: buildInfo
            server.publishBuildInfo buildInfo
         }
    }
    stage ('PostBuild') {
        steps{
            build job: 'CD pipeline', parameters [string(name: 'BUILDNUM', value: ${BUILD_NUMBER} )]
        }
    }
}
