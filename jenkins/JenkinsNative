
pipeline  {
    agent any
    environment {
        uploadSpec = ''
        server = ''
    }
    stages{
        stage ('Artifactory configuration') {         
            environment{
                 server = Artifactory.server 'JFROGTST'
            }
        }
        stage('Fetch') {
            steps {
                git credentialsId: 'GITHUB', url: 'https://github.com/yuriskltc/simple-java-maven-app.git'
            }
        }
        //withMaven(maven:'Maven') {
        stage('Test') {        
            steps{
                withMaven{
                    sh 'mvn -Dv=${BUILD_NUMBER} test'        
                }
            }
        }
        stage('Build') {
            steps{
                sh 'mvn -B -DskipTests -Dv=${BUILD_NUMBER} clean package'
            }
        }
    
        stage ('Deploy') {   
            environment{
                buildInfo = Artifactory.newBuildInfo()
            }
            steps{
                sh 'cp pom.xml target/my-app.1.1.{BUILD_NUMBER}.pom'
                
                uploadSpec = '''{
                    "files": [
                        {
                            "pattern": "target/*.jar",
                            "target": "my-libs-release-local"                  
                        }, {
                            "pattern": "target/*.pom",
                            "target": "my-libs-release-local"
                        }]
                }'''    
                buildInfo.env.collect()
                server.upload spec: uploadSpec, buildInfo: buildInfo
                server.publishBuildInfo buildInfo
            }
        }
        stage ('PostBuild') {
            steps{
                build job: 'CD pipeline', parameters [string(name: 'BUILDNUM', value: ${BUILD_NUMBER} )]
            }
        }
    }
}
